var openFB=function(){function e(e){if(!e.appId)throw"appId parameter not set in init()";u=e.appId,e.tokenStore&&(k=e.tokenStore),e.accessToken&&(k.fbAccessToken=e.accessToken),f=e.loginURL||f,h=e.logoutURL||h,w=e.oauthRedirectURL||w,g=e.cordovaOAuthRedirectURL||g,b=e.logoutRedirectURL||b}function o(e){var o=k.fbAccessToken,n={};o?(n.status="connected",n.authResponse={accessToken:o}):n.status="unknown",e&&e(n)}function n(e,o){function n(e){var o=e.url;if(o.indexOf("access_token=")>0||o.indexOf("error=")>0){var n=600-((new Date).getTime()-r);setTimeout(function(){c.close()},n>0?n:0),t(o)}}function s(){console.log("exit and remove listeners"),d&&!p&&d({status:"user_cancelled"}),c.removeEventListener("loadstop",loginWindow_loadStopHandler),c.removeEventListener("exit",s),c=null,console.log("done removing listeners")}var c,r,a="",i=l?g:w;return u?(o&&o.scope&&(a=o.scope),d=e,p=!1,r=(new Date).getTime(),c=window.open(f+"?client_id="+u+"&redirect_uri="+i+"&response_type=token&scope="+a,"_blank","location=no,clearcache=yes"),void(l&&(c.addEventListener("loadstart",n),c.addEventListener("exit",s)))):e({status:"unknown",error:"Facebook App Id not set."})}function t(e){var o,n;p=!0,e.indexOf("access_token=")>0?(o=e.substr(e.indexOf("#")+1),n=a(o),k.fbAccessToken=n.access_token,d&&d({status:"connected",authResponse:{accessToken:n.access_token}})):e.indexOf("error=")>0?(o=e.substring(e.indexOf("?")+1,e.indexOf("#")),n=a(o),d&&d({status:"not_authorized",error:n.error})):d&&d({status:"not_authorized"})}function s(e){var o,n=k.fbAccessToken;k.removeItem("fbtoken"),n&&(o=window.open(h+"?access_token="+n+"&next="+b,"_blank","location=no,clearcache=yes"),l&&setTimeout(function(){o.close()},700)),e&&e()}function c(e){var o,n=e.method||"GET",t=e.params||{},s=new XMLHttpRequest;t.access_token=k.fbAccessToken,o="https://graph.facebook.com"+e.path+"?"+i(t),s.onreadystatechange=function(){if(4===s.readyState)if(200===s.status)e.success&&e.success(JSON.parse(s.responseText));else{var o=s.responseText?JSON.parse(s.responseText).error:{message:"An error has occurred"};e.error&&e.error(o)}},s.open(n,o,!0),s.send()}function r(e,o){return c({method:"DELETE",path:"/me/permissions",success:function(){e()},error:o})}function a(e){var o=decodeURIComponent(e),n={},t=o.split("&");return t.forEach(function(e){var o=e.split("=");n[o[0]]=o[1]}),n}function i(e){var o=[];for(var n in e)e.hasOwnProperty(n)&&o.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return o.join("&")}var u,d,l,p,f="https://www.facebook.com/dialog/oauth",h="https://www.facebook.com/logout.php",k=window.sessionStorage,m=window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")),v=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+m,w=v+"/oauthcallback.html",g="https://www.facebook.com/connect/login_success.html",b=v+"/logoutcallback.html";return document.addEventListener("deviceready",function(){l=!0},!1),{init:e,login:n,logout:s,revokePermissions:r,api:c,oauthCallback:t,getLoginStatus:o}}();
angular.module("ngOpenFB",[]).factory("ngFB",["$q","$window",function(e,n){function o(e){return n.openFB.init(e)}function r(o){var r=e.defer();return n.openFB.login(function(e){"connected"===e.status?r.resolve(e):r.reject(e)},o),r.promise}function t(){var o=e.defer();return n.openFB.logout(function(){o.resolve()}),o.promise}function i(o){var r=e.defer();return o.success=function(e){r.resolve(e)},o.error=function(e){r.reject(e)},n.openFB.api(o),r.promise}function u(){var o=e.defer();return n.openFB.revokePermissions(function(){o.resolve()},function(){o.reject()}),o.promise}function s(){var o=e.defer();return n.openFB.getLoginStatus(function(e){o.resolve(e)}),o.promise}return{init:o,login:r,logout:t,revokePermissions:u,api:i,getLoginStatus:s}}]);
angular.module("dateworthy",["ionic","ngOpenFB","dateworthy.app","dateworthy.findadate","dateworthy.idea","dateworthy.services"]).run(["$ionicPlatform","$rootScope","$state","$location","ngFB",function(t,e,o,a,r){r.init({appId:"996902650371971"}),t.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),e.$on("$ionicView.enter",function(t){r.getLoginStatus().then(function(t){"connected"!==t.status&&(console.log("User is not logged in."),o.go("login"))})})})}]).config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("login",{url:"/login/",templateUrl:"templates/login.html",controller:"AppCtrl"}).state("home",{url:"/",templateUrl:"templates/home.html",controller:"AppCtrl"}).state("findadate",{url:"/findadate/:questionId/",templateUrl:"templates/findadate.html",controller:"FindADateCtrl"}).state("idea",{url:"/idea/:ideaId/",templateUrl:"templates/idea-single.html",controller:"IdeaCtrl",cache:!1}).state("error",{url:"/dangerWillRobinson/",templateUrl:"templates/error.html"}),e.otherwise("/")}]);
angular.module("dateworthy.services",[]).factory("FindADate",["$http","$location","$window","$state",function(t,e,a,n){return{sendDateData:function(e,a){return t({method:"POST",url:"/tags/sendDateData/",data:e}).then(function(t){a(t.data.ideaArray)},function(){console.log("error will robinson"),n.go("error")})}}}]).factory("LikeADate",["$http","$state","$location","$window","UserData","DateData",function(t,e,a,n,o,r){return{increaseTagWeight:function(e,a){var n=o.getUserData().email,r={tagname:e};return t({method:"POST",url:"/users/"+n+"/increaseWeight/",data:r}).then(function(t){a(t.data)})},decreaseTagWeight:function(e,a){var n=o.getUserData().email,r={tagname:e};return t({method:"POST",url:"/users/"+n+"/decreaseWeight/",data:r}).then(function(t){a(t.data)})},tag:function(a,n,i){var s=o.getUserData().email,u=a,c=n||r.getTags()[u],l={tagname:c};return t({method:"POST",url:"/users/"+s+"/tag/",data:l}).then(function(t){i(t.data)},function(){console.log("error will robinson"),e.go("error")})},markLikeDislike:function(e,a){var n={dateIdeaID:e,likeDislike:a};return t({method:"GET",url:"/users/userInfo",params:{userName:o.getUserData().email}}).then(function(t){n.userID=t.data.userID}).then(function(){t({method:"POST",url:"/users/userpreferences",data:n})}).then(function(t){console.log("Updated user prefs for dateIdeaID "+e)})}}}]).factory("FlagADate",["$http","$location","$ionicPopup",function(t,e,a){return{flaggedDates:[],flagDate:function(t,e){this.showAlert(t,e)},showAlert:function(e,n){var o=a.confirm({title:"Are you sure?",template:"Are you sure you want to flag this as a bad date idea? If enough people flag this idea, we'll scrub it from our database."});o.then(function(a){if(a){var o={dateIdeaID:e};return t({method:"POST",url:"/dateIdeas/blacklistDate/",data:o}).then(function(){n(a)})}console.log("Didn't flag")})}}}]).factory("UserData",["$http","$location","$window","$state",function(t,e,a,n){return{userData:{},updateUserData:function(e){for(var a in e)"name"===a&&(this.userData.firstName=e[a].split(" ")[0]),this.userData[a]=e[a];return console.log("Current user Data: ",this.userData),console.log("Attempting to push data to SQL"),t({method:"POST",url:"/users/",data:e}).then(function(t){},function(){console.log("error will robinson"),n.go("error")})},getUserData:function(){return this.userData}}}]).factory("DateData",["$http","$location","$window","$cordovaGeolocation","UserData",function(t,e,a,n,o){return{tags:{},logistics:{},dateIdeas:{},geoLocation:null,appendTags:function(t){for(var e in t)"undefined"===e||this.tags.hasOwnProperty(e)||(this.tags[e]=t[e])},getTags:function(){return this.tags},appendLogistics:function(t){for(var e in t)this.logistics[e]=t[e]},getLogistics:function(){return this.logistics},setGeoLocation:function(t,e){if(t&&e)this.geoLocation={lat:t,"long":e};else{var a={timeout:1e4,enableHighAccuracy:!1},o=this;n.getCurrentPosition(a).then(function(t){var e=t.coords.latitude,a=t.coords.longitude;o.geoLocation={lat:e,"long":a}},function(t){})}},getGeoLocation:function(){return this.geoLocation},setDateIdeas:function(t){this.dateIdeas=t},getDateIdeas:function(t){t(this.dateIdeas)},getConcatenatedData:function(){var t=o.getUserData(),e=[];for(var a in this.tags)void 0!==this.tags[a]&&e.push(this.tags[a]);return{userName:t.email,tags:e,logistics:this.logistics,geoLocation:this.geoLocation}},clearData:function(){this.tags={},this.logistics={},this.dateIdeas={}}}}]).factory("Auth",["$http","$location",function(t,e){return{login:function(e,a){return t({method:"POST",url:"/users/signup",data:e}).then(function(t){a(t)})}}}]);
angular.module("dateworthy.app",["ngOpenFB","ngCordova","angularSpinner"]).controller("AppCtrl",["$state","$scope","$ionicModal","$ionicPlatform","$timeout","$location","$rootScope","$cordovaGeolocation","DateData","UserData","ngFB",function(e,n,t,a,o,s,i,c,r,u,l){n.fbLogin=function(){l.login({scope:"email,publish_actions"}).then(function(n){return"connected"===n.status?(e.go("home"),n):void alert("Facebook login failed")}).then(function(e){var n={path:"/me",params:{access_token:e.authResponse.accessToken,fields:"id,name,email"}};return l.api(n)}).then(function(e){u.updateUserData(e),g()})},a.ready(function(){r.setGeoLocation(),l.getLoginStatus().then(function(n){"connected"!==n.status&&(console.log("User is not logged in."),e.go("login"))})});var g=function(){n.userData=u.getUserData()},p=function(){var e={path:"/me",params:{access_token:window.sessionStorage.fbAccessToken,fields:"id,name,email"}};return e.params.access_token?l.api(e).then(function(e){u.updateUserData(e),g()}):void 0};n.$on("$stateChangeSuccess",function(){n.userData&&0!==Object.keys(n.userData).length||p()}),p()}]);
angular.module("dateworthy.findadate",[]).controller("FindADateCtrl",["$scope","$state","$location","$timeout","$stateParams","$ionicHistory","$ionicPlatform","$document","FindADate","DateData","LikeADate",function(e,t,o,n,i,a,s,r,c,l,u){e.showSpinner=!1,e.questions=[{question:"What type of date do you enjoy in general?",type:"tag",field:"dateGenre",possibilities:["Intellectual","Romantic","Goofy","Geeky"]},{question:"When are you going?",type:"logistics",field:"time",possibilities:["Today","Tonight","Tomorrow"]},{question:"How long is your date?",type:"logistics",field:"length",possibilities:["30 minutes","1 hour","2 hours"]},{question:"What's your mode of transportation?",type:"logistics",field:"transportation",possibilities:["I'm walking","I'm taking a cab","I'm driving","Public trans, baby!"]},{question:"Would you prefer a loud or quiet setting?",type:"tag",field:"noiseLevel",possibilities:["Loud","Quiet"]},{question:"Type in the city or location for your desired date location.",type:"logistics",field:"location",possibilities:[]}],e.data={},e.currentIndex=i.questionId,e.currentQuestion=e.questions[e.currentIndex],e.loadState=function(){e.currentLogistics=l.getLogistics(),e.currentTags=l.getTags(),g(e.currentQuestion)};var g=function(t){void 0!==e.currentLogistics&&(e.currentLogistics.hasOwnProperty(t.field)&&(e.currentQuestion.chosenOption=e.currentLogistics[t.field]),e.currentTags.hasOwnProperty(t.field)&&(e.currentQuestion.chosenOption=e.currentTags[t.field]))};e.prevQuestion=function(){d(),a.goBack(),e.loadState()},e.createQuestionObject=function(e){var t={},o=e.field;return t[o]=e.chosenOption,t};var d=function(){var t=e.currentQuestion,o=e.createQuestionObject(t);"logistics"===t.type?l.appendLogistics(o):l.appendTags(o)};e.nextQuestion=function(){d();var o,n=Number(e.currentIndex)+1;if(n===e.questions.length){e.showSpinner=!0;var i=e.map.getCenter(),a=i.lat(),s=i.lng();l.setGeoLocation(a,s);for(prop in e.currentTags)o=e.currentTags[prop],void 0!==o&&u.tag(null,o,function(e,t){e&&console.log(e)});c.sendDateData(l.getConcatenatedData(),function(o){console.log(l.getConcatenatedData(),"DATA WE ARE sending"),l.setDateIdeas(o),e.loadState(),t.go("idea",{ideaId:0})})}else t.go("findadate",{questionId:n}),e.loadState()},e.initMap=function(){console.log("Initializing map");var t=l.getGeoLocation();if(t)var o=t.lat||37.8044,n=t["long"]||-122.2708;var i=new google.maps.Map(document.getElementById("map"),{draggable:!1,center:{lat:o||37.8044,lng:n||-122.2708},zoom:10,mapTypeId:google.maps.MapTypeId.ROADMAP}),a=document.getElementById("pac-input"),s=new google.maps.places.SearchBox(a);i.addListener("bounds_changed",function(){s.setBounds(i.getBounds())});var r=[];s.addListener("places_changed",function(){var e=s.getPlaces();if(0!=e.length){r.forEach(function(e){e.setMap(null)}),r=[];var t=new google.maps.LatLngBounds;e.forEach(function(e){var o={url:e.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};r.push(new google.maps.Marker({map:i,icon:o,title:e.name,position:e.geometry.location})),e.geometry.viewport?t.union(e.geometry.viewport):t.extend(e.geometry.location)}),i.fitBounds(t)}}),e.map=i},e.loadMapCheck=function(t){return t||(t=0),e.currentIndex===e.questions.length-1-t+""?!0:!1},e.loadState()}]);
angular.module("dateworthy.idea",["ngOpenFB","ngCordova"]).controller("IdeaCtrl",["$state","$location","$q","$scope","$stateParams","DateData","LikeADate","FlagADate",function(e,a,i,d,n,t,o,l){d.ideas={},d.initMap=function(e,a,i){console.log("Initiating Map...",e,a);var t=new google.maps.LatLng(e,a),o={draggable:!1,center:t,zoom:16,mapTypeId:google.maps.MapTypeId.ROADMAP},l=new google.maps.Map(document.getElementById("venueMap"+n.ideaId),o);navigator.geolocation.getCurrentPosition(function(d){l.setCenter(new google.maps.LatLng(e,a));new google.maps.Marker({position:new google.maps.LatLng(e,a),map:l,title:i})}),d["venueMap"+n.ideaId]=l,d.idea.mapInit=!0},d.toggleDetails=function(){console.log("Toggling details"),d.idea.detailsVisible===!1?d.idea.detailsVisible=!0:d.idea.detailsVisible=!1},d.$on("$stateChangeSuccess",function(){e.includes("idea")&&t.getDateIdeas(function(e){d.ideas=e,console.log(d.ideas),d.currentIdea=Number(n.ideaId),d.imgWidth=window.innerWidth+"px",console.log("innerwidth is",d.imgWidth),d.idea=d.ideas[d.currentIdea],d.idea.index=d.currentIdea,d.idea.last=!1,d.idea.mapInit=!1,d.idea.flagged=d.idea.flagged||!1,console.log("$scope.idea.index",d.idea.index),d.idea.index===d.ideas.length-1&&(d.idea.last=!0),d.idea.detailsVisible=!1})}),d.currentIdea=0,d.showDetails=function(){console.log("Details should be vis now"),d.idea.detailsVisible=!0,console.log("$scope.idea.detailsVisible",d.idea.detailsVisible)},d.like=function(){var e=d.currentIdea;d.ideas[e].liked=1,d.ideas[e].disliked=0;var a=t.getTags();for(var i in a)void 0!==a[i]&&o.increaseTagWeight(a[i],function(e){console.log(e)});o.markLikeDislike(d.ideas[e].dateIdeaID,1)},d.dislike=function(){var e=d.currentIdea;d.ideas[d.currentIdea].disliked=1,d.ideas[d.currentIdea].liked=0;var a=t.getTags();for(var i in a)void 0!==a[i]&&o.decreaseTagWeight(a[i],function(e){console.log(e)});o.markLikeDislike(d.ideas[e].dateIdeaID,-1)},d.flagDate=function(){var e=d.ideas[d.currentIdea].dateIdeaID;l.flagDate(e,function(){d.idea.flagged=!0})},d.nextIdea=function(){var a=Number(d.currentIdea)+1;e.go("idea",{ideaId:a})},d.prevIdea=function(){var a=Number(d.currentIdea)-1;e.go("idea",{ideaId:a})},d.clearData=function(){d.ideas=[],d.currentIdea=0,t.clearData(),e.go("home")}}]);